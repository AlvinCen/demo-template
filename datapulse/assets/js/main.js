(function(){
  const html=document.documentElement;const saved=localStorage.getItem('dp-theme');if(saved==='dark')html.classList.add('dark');
  document.addEventListener('click',e=>{const t=e.target.closest('[data-theme-toggle]');if(t){html.classList.toggle('dark');localStorage.setItem('dp-theme',html.classList.contains('dark')?'dark':'light');}});
  const USERS='dp_users',ORDERS='dp_orders',APIK='dp_api_keys';const get=k=>JSON.parse(localStorage.getItem(k)||'[]');const set=(k,v)=>localStorage.setItem(k,JSON.stringify(v));const money=n=>'$'+(Math.round(n*100)/100).toLocaleString(undefined,{minimumFractionDigits:0});
  (function seed(){if(get(USERS).length===0){const plans=['Free','Pro','Business'];const regions=['US','EU','APAC'];const arr=[];for(let i=1;i<=120;i++){arr.push({id:'U'+String(i).padStart(3,'0'),name:'User '+i,email:`user${i}@example.com`,plan:plans[i%3],region:regions[i%3],joined:`2025-${String((i%9)+1).padStart(2,'0')}-${String((i%28)+1).padStart(2,'0')}`});}set(USERS,arr);}if(get(ORDERS).length===0){const arr=[];for(let m=1;m<=12;m++){arr.push({month:m,mrr:10000+Math.floor(Math.random()*5000)+m*700,dau:800+m*30+Math.floor(Math.random()*120),signups:120+Math.floor(Math.random()*80),churn:+(Math.random()*3.5+1).toFixed(2)});}set(ORDERS,arr);}})();
  function renderDashboard(){const wrap=document.querySelector('[data-dashboard]');if(!wrap)return;const data=get(ORDERS);wrap.querySelector('[data-mrr]').textContent=money(data[data.length-1].mrr);wrap.querySelector('[data-arr]').textContent=money(Math.round(data.reduce((s,x)=>s+x.mrr,0)*12/12));wrap.querySelector('[data-dau]').textContent=(data[data.length-1]?.dau||0).toLocaleString();wrap.querySelector('[data-churn]').textContent=(data.reduce((s,x)=>s+x.churn,0)/data.length).toFixed(2)+'%';}
  renderDashboard();
  function drawLine(id,series){const c=document.getElementById(id);if(!c)return;const ctx=c.getContext('2d');const w=c.width=c.clientWidth;const h=c.height=260;ctx.clearRect(0,0,w,h);const pad=32;const xs=series.map((_,i)=>pad+i*((w-2*pad)/(series.length-1)));const max=Math.max(...series)*1.1,min=Math.min(...series)*0.9;const scale=y=>h-pad-((y-min)/(max-min))*(h-2*pad);ctx.lineWidth=2;ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--primary')||'#6366f1';ctx.beginPath();xs.forEach((x,i)=>{const y=scale(series[i]);i?ctx.lineTo(x,y):ctx.moveTo(x,y);});ctx.stroke();const grad=ctx.createLinearGradient(0,pad,0,h-pad);grad.addColorStop(0,'rgba(99,102,241,.25)');grad.addColorStop(1,'rgba(99,102,241,0)');ctx.fillStyle=grad;ctx.lineTo(w-pad,h-pad);ctx.lineTo(pad,h-pad);ctx.closePath();ctx.fill();}
  function drawBars(id,series){const c=document.getElementById(id);if(!c)return;const ctx=c.getContext('2d');const w=c.width=c.clientWidth;const h=c.height=260;ctx.clearRect(0,0,w,h);const pad=32;const bw=(w-2*pad)/series.length*0.7;const max=Math.max(...series)*1.2;const scale=y=>(y/max)*(h-2*pad);ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--primary')||'#6366f1';series.forEach((v,i)=>{const x=pad+i*((w-2*pad)/series.length)+((w-2*pad)/series.length-bw)/2;const hh=scale(v);ctx.fillRect(x,h-pad-hh,bw,hh);});}
  function drawPie(id,parts){const c=document.getElementById(id);if(!c)return;const ctx=c.getContext('2d');const w=c.width=c.clientWidth;const h=c.height=260;ctx.clearRect(0,0,w,h);const r=Math.min(w,h)/2-16;const cx=w/2,cy=h/2;const colors=['#6366f1','#22c55e','#f59e0b','#ef4444','#06b6d4'];const sum=parts.reduce((s,p)=>s+p.value,0);let ang=-Math.PI/2;parts.forEach((p,i)=>{const a=(p.value/sum)*Math.PI*2;ctx.fillStyle=colors[i%colors.length];ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,ang,ang+a);ctx.closePath();ctx.fill();ang+=a;});const legend=document.querySelector(`[data-legend='${id}']`);if(legend){legend.innerHTML=parts.map((p,i)=>`<div class='badge' style='display:inline-flex;align-items:center;gap:6px;margin:4px 6px 0 0'><span style='display:inline-block;width:10px;height:10px;background:${colors[i%colors.length]};border-radius:2px'></span>${p.label}</div>`).join('');}}
  function renderCharts(){const rows=get(ORDERS);drawLine('mrrChart',rows.map(r=>r.mrr));drawBars('signupChart',rows.map(r=>r.signups));const users=get(USERS);const mix=[{label:'Free',value:users.filter(u=>u.plan==='Free').length},{label:'Pro',value:users.filter(u=>u.plan==='Pro').length},{label:'Business',value:users.filter(u=>u.plan==='Business').length},];drawPie('planChart',mix);}renderCharts();window.addEventListener('resize',renderCharts);
  function renderReports(){const wrap=document.querySelector('[data-reports]');if(!wrap)return;const rows=get(ORDERS);const head='<tr><th>#</th><th>Month</th><th>MRR</th><th>DAU</th><th>Signups</th><th>Churn %</th></tr>';const body=rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.month}</td><td>${money(r.mrr)}</td><td>${r.dau}</td><td>${r.signups}</td><td>${r.churn}</td></tr>`).join('');wrap.innerHTML=head+body;}renderReports();const exp=document.querySelector('[data-export]');if(exp){exp.addEventListener('click',()=>{const rows=get(ORDERS);const csv=['month,mrr,dau,signups,churn'].concat(rows.map(r=>[r.month,r.mrr,r.dau,r.signups,r.churn].join(','))).join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='reports.csv';a.click();setTimeout(()=>URL.revokeObjectURL(url),500);});}
  function renderUsers(){const wrap=document.querySelector('[data-users]');if(!wrap)return;const q=(document.querySelector('[name=q]')?.value||'').toLowerCase();const plan=(document.querySelector('[name=plan]')?.value||'');const region=(document.querySelector('[name=region]')?.value||'');const list=get(USERS).filter(u=>(!q||(u.name+u.email).toLowerCase().includes(q))&&(!plan||u.plan===plan)&&(!region||u.region===region));const head='<tr><th>ID</th><th>Name</th><th>Email</th><th>Plan</th><th>Region</th><th>Joined</th></tr>';const body=list.map(u=>`<tr><td>${u.id}</td><td>${u.name}</td><td>${u.email}</td><td>${u.plan}</td><td>${u.region}</td><td>${u.joined}</td></tr>`).join('');wrap.innerHTML=head+body||'<tr><td colspan="6">No users.</td></tr>';}renderUsers();document.querySelector('[data-user-filters]')?.addEventListener('input',renderUsers);
  function renderInvoices(){const wrap=document.querySelector('[data-invoices]');if(!wrap)return;const rows=get(ORDERS).slice(-6).map((r,i)=>({id:'INV-'+String(1000+i),date:`2025-${String((r.month%12)||12).padStart(2,'0')}-01`,amount:r.mrr/10}));wrap.innerHTML=rows.map(r=>`<tr><td>${r.id}</td><td>${r.date}</td><td style='text-align:right'>${money(r.amount)}</td><td style='text-align:right'><a class='btn ghost' href='#'>PDF</a></td></tr>`).join('');}renderInvoices();
  function randKey(){return Array.from(crypto.getRandomValues(new Uint8Array(24))).map(b=>('0'+b.toString(16)).slice(-2)).join('');}
  function renderKeys(){const wrap=document.querySelector('[data-keys]');if(!wrap)return;const keys=get(APIK);wrap.innerHTML=keys.map(k=>`<tr><td>${k.id}</td><td>${k.created}</td><td><code>${k.value.slice(0,8)}•••</code></td><td style='text-align:right'><button class='btn danger' data-del='${k.id}'>Revoke</button></td></tr>`).join('')||'<tr><td colspan="4">No API keys yet.</td></tr>';}renderKeys();
  document.querySelector('[data-newkey]')?.addEventListener('click',()=>{const keys=get(APIK);const id='key_'+(keys.length+1);keys.push({id,created:new Date().toISOString().slice(0,10),value:randKey()});set(APIK,keys);renderKeys();});
  document.addEventListener('click',e=>{const del=e.target.closest('[data-del]');if(!del)return;const id=del.getAttribute('data-del');const keys=get(APIK).filter(k=>k.id!==id);set(APIK,keys);renderKeys();});
  document.addEventListener('submit',e=>{const f=e.target.closest('[data-ajax]');if(!f)return;e.preventDefault();alert('Saved! (Demo)');f.reset();});
})();